<!DOCTYPE html>
<html lang="sk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pripomienky - CHICHO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
</head>

<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebar" class="hidden lg:block fixed left-0 top-0 w-80 bg-white border-r h-screen"></div>

    <!-- Mobile Header -->
    <div id="mobileHeader" class="lg:hidden"></div>

    <!-- Main Content -->
    <div class="lg:ml-80 p-6">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Správa pripomienok</h1>

            <!-- Tabs -->
            <div class="flex space-x-4 mb-6 border-b">
                <button onclick="filterFeedback('all')" id="tabAll"
                    class="pb-2 px-4 font-medium border-b-2 border-red-600 text-red-600">
                    Všetky
                </button>
                <button onclick="filterFeedback('nevybavena')" id="tabNew"
                    class="pb-2 px-4 font-medium text-gray-600 hover:text-gray-900">
                    Nevybavené
                </button>
                <button onclick="filterFeedback('vybavena')" id="tabResolved"
                    class="pb-2 px-4 font-medium text-gray-600 hover:text-gray-900">
                    Vybavené
                </button>
            </div>

            <!-- Feedback List -->
            <div id="feedbackList" class="space-y-4">
                <p class="text-center text-gray-500">Načítavam...</p>
            </div>
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        const API_BASE = '../api';
        let allFeedback = [];
        let currentFilter = 'all';

        async function init() {
            const user = await requireAdmin();
            if (!user) return;

            document.getElementById('sidebar').innerHTML = createSidebar(user, 'feedback');
            document.getElementById('mobileHeader').innerHTML = createMobileHeader(user);

            loadFeedback();
        }

        async function loadFeedback() {
            try {
                const res = await fetch(`${API_BASE}/feedback.php`);
                const data = await res.json();
                allFeedback = data.pripomienky || [];
                renderFeedback();
            } catch (err) {
                document.getElementById('feedbackList').innerHTML = '<p class="text-center text-red-600">Chyba pri načítavaní</p>';
            }
        }

        function filterFeedback(filter) {
            currentFilter = filter;

            // Update tabs
            document.querySelectorAll('[id^="tab"]').forEach(tab => {
                tab.className = 'pb-2 px-4 font-medium text-gray-600 hover:text-gray-900';
            });
            document.getElementById(`tab${filter === 'all' ? 'All' : filter === 'nevybavena' ? 'New' : 'Resolved'}`).className = 'pb-2 px-4 font-medium border-b-2 border-red-600 text-red-600';

            renderFeedback();
        }

        function renderFeedback() {
            const filtered = currentFilter === 'all' ? allFeedback : allFeedback.filter(f => f.stav === currentFilter);

            const list = document.getElementById('feedbackList');

            if (filtered.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">Žiadne pripomienky</p>';
                return;
            }

            list.innerHTML = filtered.map(f => `
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg">
                                <a href="../navod.html?slug=${f.navod_slug}" class="text-blue-600 hover:text-blue-800">
                                    ${f.navod_nazov}
                                </a>
                            </h3>
                            <p class="text-sm text-gray-600">
                                Od: ${f.user_name} (${f.user_email})
                                ${f.cislo_kroku ? `• Krok ${f.cislo_kroku}` : ''}
                            </p>
                        </div>
                        <span class="px-3 py-1 text-xs rounded-full ${f.stav === 'nevybavena' ? 'bg-orange-100 text-orange-800' : 'bg-green-100 text-green-800'}">
                            ${f.stav === 'nevybavena' ? 'Nevybavené' : 'Vybavené'}
                        </span>
                    </div>
                    <p class="text-gray-700 mb-4">${f.sprava}</p>
                    <div class="flex justify-between items-center text-sm text-gray-500">
                        <span>${formatDate(f.created_at)}</span>
                        <div class="space-x-3">
                            ${f.stav === 'nevybavena' ? `
                                <button onclick="resolveFeedback(${f.id})" class="text-green-600 hover:text-green-800 font-medium">
                                    ✓ Vyriešiť
                                </button>
                            ` : ''}
                            <button onclick="deleteFeedback(${f.id})" class="text-red-600 hover:text-red-800 font-medium">
                                Vymazať
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function resolveFeedback(id) {
            try {
                await fetch(`${API_BASE}/feedback.php`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                loadFeedback();
            } catch (err) {
                alert('Chyba');
            }
        }

        async function deleteFeedback(id) {
            if (!confirm('Naozaj vymazať?')) return;

            try {
                await fetch(`${API_BASE}/feedback.php`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
                loadFeedback();
            } catch (err) {
                alert('Chyba');
            }
        }

        init();
    </script>
</body>

</html>